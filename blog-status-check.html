<!DOCTYPE html>
<html>
<head>
    <title>Blog Generation Status Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status-pending { color: orange; }
        .status-processing { color: blue; }
        .status-completed { color: green; }
        .status-failed { color: red; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .refresh-btn { margin: 10px; padding: 10px 20px; background: #007cba; color: white; border: none; cursor: pointer; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 5px; min-width: 150px; }
        .progress-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #4caf50; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>üöÄ Blog Generation Status Monitor</h1>
    
    <div class="stats" id="stats"></div>
    
    <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh All</button>
    <button class="refresh-btn" onclick="toggleAutoRefresh()">‚è±Ô∏è Toggle Auto-Refresh</button>
    <span id="auto-status">Auto-refresh: OFF</span>
    
    <h2>üìä Keywords Status</h2>
    <div id="keywords-progress"></div>
    <table id="keywords-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Keyword</th>
                <th>Status</th>
                <th>Blog Generated</th>
                <th>Category</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody id="keywords-body"></tbody>
    </table>
    
    <h2>üìù Generated Blogs</h2>
    <table id="blogs-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Keyword</th>
                <th>Status</th>
                <th>Word Count</th>
                <th>Published</th>
                <th>Live URL</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody id="blogs-body"></tbody>
    </table>
    
    <div id="logs"></div>
    
    <script>
        const API_BASE = 'http://localhost:8001';
        let autoRefresh = false;
        let refreshInterval;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logs = document.getElementById('logs');
            logs.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(message);
        }
        
        const getAuthHeaders = () => ({
            'Authorization': 'Bearer fake-token',
            'Content-Type': 'application/json',
        });
        
        async function loadKeywords() {
            try {
                const response = await fetch(`${API_BASE}/api/keywords/`, {
                    headers: getAuthHeaders(),
                });
                
                if (response.ok) {
                    const keywords = await response.json();
                    displayKeywords(keywords);
                    return keywords;
                } else {
                    log(`‚ùå Failed to load keywords: ${response.status}`, 'error');
                    return [];
                }
            } catch (error) {
                log(`‚ùå Error loading keywords: ${error.message}`, 'error');
                return [];
            }
        }
        
        async function loadBlogs() {
            try {
                const response = await fetch(`${API_BASE}/api/blogs/`, {
                    headers: getAuthHeaders(),
                });
                
                if (response.ok) {
                    const blogs = await response.json();
                    displayBlogs(blogs);
                    return blogs;
                } else {
                    log(`‚ùå Failed to load blogs: ${response.status}`, 'error');
                    return [];
                }
            } catch (error) {
                log(`‚ùå Error loading blogs: ${error.message}`, 'error');
                return [];
            }
        }
        
        async function loadStats() {
            try {
                const [keywordStats, blogStats] = await Promise.all([
                    fetch(`${API_BASE}/api/keywords/stats`, { headers: getAuthHeaders() }),
                    fetch(`${API_BASE}/api/blogs/stats/overview`, { headers: getAuthHeaders() })
                ]);
                
                const keywordData = keywordStats.ok ? await keywordStats.json() : {};
                const blogData = blogStats.ok ? await blogStats.json() : {};
                
                displayStats(keywordData, blogData);
            } catch (error) {
                log(`‚ùå Error loading stats: ${error.message}`, 'error');
            }
        }
        
        function displayStats(keywordStats, blogStats) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h3>üìù Keywords</h3>
                    <div>Total: ${keywordStats.total_keywords || 0}</div>
                    <div>Pending: ${keywordStats.pending || 0}</div>
                    <div>Processing: ${keywordStats.processing || 0}</div>
                    <div>Completed: ${keywordStats.completed || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>üìö Blogs</h3>
                    <div>Total: ${blogStats.total_blogs || 0}</div>
                    <div>Published: ${blogStats.published_blogs || 0}</div>
                    <div>Draft: ${(blogStats.total_blogs || 0) - (blogStats.published_blogs || 0)}</div>
                </div>
                <div class="stat-card">
                    <h3>üìà Progress</h3>
                    <div>Completion: ${keywordStats.completion_rate || 0}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${keywordStats.completion_rate || 0}%"></div>
                    </div>
                </div>
            `;
        }
        
        function displayKeywords(keywords) {
            const tbody = document.getElementById('keywords-body');
            tbody.innerHTML = keywords.map(keyword => `
                <tr>
                    <td>${keyword.id}</td>
                    <td><strong>${keyword.keyword}</strong></td>
                    <td class="status-${keyword.status}">${keyword.status}</td>
                    <td>${keyword.blog_generated ? '‚úÖ' : '‚ùå'}</td>
                    <td>${keyword.category || '-'}</td>
                    <td>${new Date(keyword.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
            
            // Progress bar for keywords
            const total = keywords.length;
            const completed = keywords.filter(k => k.status === 'completed').length;
            const processing = keywords.filter(k => k.status === 'processing').length;
            const progressDiv = document.getElementById('keywords-progress');
            progressDiv.innerHTML = `
                <div>Keywords Progress: ${completed}/${total} completed, ${processing} processing</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${total > 0 ? (completed/total)*100 : 0}%"></div>
                </div>
            `;
        }
        
        function displayBlogs(blogs) {
            const tbody = document.getElementById('blogs-body');
            if (blogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No blogs generated yet. Click "Generate Blog" on keywords to create blogs.</td></tr>';
                return;
            }
            
            tbody.innerHTML = blogs.map(blog => `
                <tr>
                    <td>${blog.id}</td>
                    <td><strong>${blog.title}</strong></td>
                    <td>${blog.keyword || '-'}</td>
                    <td class="status-${blog.status}">${blog.status}</td>
                    <td>${blog.word_count || '-'}</td>
                    <td>${blog.published ? '‚úÖ' : '‚ùå'}</td>
                    <td>${blog.live_url ? `<a href="${blog.live_url}" target="_blank">View</a>` : '-'}</td>
                    <td>${new Date(blog.created_at).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        async function refreshAll() {
            log('üîÑ Refreshing all data...');
            await Promise.all([
                loadKeywords(),
                loadBlogs(),
                loadStats()
            ]);
            log('‚úÖ Data refreshed successfully');
        }
        
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            const status = document.getElementById('auto-status');
            
            if (autoRefresh) {
                status.textContent = 'Auto-refresh: ON (every 10s)';
                refreshInterval = setInterval(refreshAll, 10000);
                log('‚è±Ô∏è Auto-refresh enabled (10 seconds)');
            } else {
                status.textContent = 'Auto-refresh: OFF';
                clearInterval(refreshInterval);
                log('‚è∏Ô∏è Auto-refresh disabled');
            }
        }
        
        // Initial load
        window.onload = () => {
            log('üöÄ Loading blog generation status...');
            refreshAll();
        };
    </script>
</body>
</html>